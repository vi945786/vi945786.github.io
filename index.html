<html>
<head>
<script src="https://cookiesaver-6dd8.restdb.io/assets/js/eventsource.min.js"></script>
<script src="https://cookiesaver-6dd8.restdb.io/rest/_jsapi.js?plainjs=true"></script>
<script>

var db = new restdb("657af4b23fc01b465d5b055f")
var saveFile;

var originalWindowOnbeforeunload = window.onbeforeunload;
window.addEventListener("beforeunload", function(event) {
		
	if(saveFile == undefined) return;
	
	Game.WriteSave();
	var save = localStorageGet("CookieClickerGame");
	saveFile.savefile.game = save;
	saveFile.save();
	
	var start = new Date().getTime();
	var end = start;
	while(end < start + 1500) {
		end = new Date().getTime();
	}
	
	originalWindowOnbeforeunload()
	  

});

var currentUrl = document.baseURI.split("/")
currentUrl.pop()
currentUrl = currentUrl.join("/")

var originalAppendChild = HTMLElement.prototype.appendChild;
HTMLElement.prototype.appendChild = function(element) {
    if (!element) return;

    if (element.tagName == "SCRIPT") {
        element.src = element.src.replace(currentUrl, "https://orteil.dashnet.org/cookieclicker").replace("file", "https");
		element.text = element.text.replace(currentUrl, "https://orteil.dashnet.org/cookieclicker").replace("file", "https");
    } else if (element.tagName == "LINK") {
        element.href = element.href.replace(currentUrl, "https://orteil.dashnet.org/cookieclicker").replace("file", "https");
    } else if (element.tagName == "IMG") {
        element.src = element.src.replace(currentUrl, "https://orteil.dashnet.org/cookieclicker").replace("file", "https");
    }
	
	if(element.style) element.style.cssText = element.style.cssText.replace('url\("img\/', "url(https://orteil.dashnet.org/cookieclicker/img/");

    return originalAppendChild.call(this, element);
};

(async function() {
var doc = await getDoc();

doc.head.innerHTML = doc.head.innerHTML.replaceAll("url(img/", "url(https://orteil.dashnet.org/cookieclicker/img/").replaceAll("file", "https");
doc.body.innerHTML = doc.body.innerHTML.replaceAll("url(img/", "url(https://orteil.dashnet.org/cookieclicker/img/").replaceAll("file", "https");

Array.prototype.slice.call(doc.getElementsByClassName("ad")).forEach(ad => {
	ad.parentNode.removeChild(ad);
});

document.head.innerHTML = "";
document.body.innerHTML = "";

Array.prototype.slice.call(doc.body.childNodes).forEach(element => {
	if(element.tagName === "SCRIPT") {
		appendScript(element, document.body);
	} else {
		document.body.appendChild(element);
	}
})

Array.prototype.slice.call(doc.head.childNodes).forEach(element => {
	if(element.tagName === "SCRIPT") {
		appendScript(element, document.head);
	} else {
		document.head.appendChild(element);
	}
})

})();

var fixAjax=function fetchData(url, callback) {
  if (url.startsWith("/")) url = "https://orteil.dashnet.org" + url;

  if (url.indexOf('?')==-1) url+='?'; else url+='&';
  url += 'nocache=' + Date.now();

  fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`)
    .then(response => response.text())
    .then(data => callback(JSON.parse(data)['contents'].substring(1)));
}

function checkGame() {
    try {
		Game.resPath='https://cdn.dashnet.org/cookieclicker/';
		Game.local = false;
		ajax = fixAjax;
		OldPlaySound = function(url,vol) {};
		PlaySound = function(url,vol,pitchVar) {};
		PlayMusicSound = function(url,vol,pitchVar) {};
		
		Game.Launch = eval("(" + Game.Launch.toString().replaceAll('url(img/', "url(https://orteil.dashnet.org/cookieclicker/img/") + '' + ")");

		localStorageSet("CookieClickerLang", "EN")
		new db.gamesaver.find({}, {}, function(err, res) {
			saveFile = res[0];
			localStorageSet("CookieClickerGame", saveFile.savefile.game)
			window.onload();
		})


		
	} catch(error) {
		window.setTimeout(checkGame, 100);
	}
}
checkGame();

function checkLinks() {
    try {
		if(document.getElementById("linkVersionLive")) throw new Error()
		
		Array.prototype.slice.call(document.getElementsByClassName("supportComment")).forEach(tag => {
			tag.parentNode.removeChild(tag)
		})
		
		document.getElementById("links").parentNode.removeChild(document.getElementById("links"));
	} catch(error) {
		window.setTimeout(checkLinks, 100);
	}
}
checkLinks();

async function getDoc() {
	var html = await fetchHtml('https://orteil.dashnet.org/cookieclicker')
	
	const parser = new DOMParser();
	var doc = parser.parseFromString(html, "text/html")
	
	var docHead = parser.parseFromString(html.split("head>")[1].slice(0, -2), "text/html")
	
	Array.prototype.slice.call(docHead.body.childNodes).forEach(element => {
		docHead.head.append(element)
	})
	
	var docBody = parser.parseFromString(html.split("body>")[1].slice(0, -2), "text/html")
	
	Array.prototype.slice.call(docBody.head.childNodes).forEach(element => {
		docBody.body.append(element)
	})
	
	doc.head.innerHTML = docHead.head.innerHTML;
	doc.body.innerHTML = docBody.body.innerHTML;
	
	return doc;
}

async function appendScript(element, parentNode) {
	var scriptType = element.src=='' ? "innerHTML" : "src";
	var scriptContent = element[scriptType];
	if(scriptContent.includes("ad")) return;
	
	var script = document.createElement("script");
	script[scriptType] = scriptContent.replace(currentUrl, "https://orteil.dashnet.org/cookieclicker").replace("file", "https");
	parentNode.append(script);
}

function fetchHtml(url) {
    return fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`)
        .then(response => {
            if (response.ok) {
				return response.json().then(data => data.contents);
            } else {
                throw new Error('Network response was not ok.');
            }
        })
        .catch(error => {
            throw error;
        });
}
</script>
</head>
<body></body>